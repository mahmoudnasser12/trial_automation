name: Strict Commit Template & Auto-Revert

on:
  push:
    branches-ignore:
      - develop

permissions:
  contents: write

jobs:
  validate-and-revert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Template & Revert if Needed
        id: check_msg
        env:
          # Pass the commit message safely as an Environment Variable
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        shell: python
        run: |
          import os
          import re
          import sys
          import subprocess

          # --- 1. CLEAN & PARSE ---
          msg = os.environ.get("COMMIT_MSG", "")
          
          # Split by newline, strip whitespace from every line, AND REMOVE EMPTY LINES
          # This flattens "PROJ-1024 \n\n\n Fix" into ["PROJ-1024", "Fix"]
          raw_lines = msg.split('\n')
          content_lines = [line.strip() for line in raw_lines if line.strip()]

          print(f"Found {len(content_lines)} blocks of content (ignoring whitespace).")
          for i, line in enumerate(content_lines):
              print(f"Block {i+1}: {line}")

          # --- 2. CONFIGURATION ---
          REGEX_TICKET = r"^[A-Z]+-[0-9]+$"       # Matches PROJ-123
          REGEX_VERSION = r"^v[0-9]+\.[0-9]+$"    # Matches v1.0
          REGEX_TYPE = r"^(Feature|Bugfix|Refactor|Docs)$"

          errors = []

          # --- 3. LOGIC (Sequence Based) ---
          
          # We need at least 5 blocks: Ticket, Summary, Version, Type, Description
          if len(content_lines) < 5:
              errors.append(f"Missing information. Found {len(content_lines)}/5 required sections.")
              errors.append("Expected order: Ticket -> Summary -> Version -> Type -> Description")
          else:
              # Block 1: Ticket
              if not re.match(REGEX_TICKET, content_lines[0]):
                  errors.append(f"1st Section (Ticket): '{content_lines[0]}' must match format PROJ-123")

              # Block 2: Summary (Free text, just ensure it's not the Version)
              if re.match(REGEX_VERSION, content_lines[1]):
                  errors.append(f"2nd Section (Summary): You seem to have skipped the Summary and wrote Version '{content_lines[1]}' instead.")

              # Block 3: Version
              if not re.match(REGEX_VERSION, content_lines[2]):
                  errors.append(f"3rd Section (Version): '{content_lines[2]}' must match format vX.X")

              # Block 4: Type
              if not re.match(REGEX_TYPE, content_lines[3]):
                  errors.append(f"4th Section (Type): '{content_lines[3]}' is invalid. Allowed: Feature, Bugfix, Refactor, Docs")

              # Block 5+: Description
              # (We just check that it exists, which we did via len checks)

          # --- 4. DECISION ---
          if not errors:
              print("‚úÖ ACCEPTED: Commit content sequence is correct.")
              sys.exit(0)
          
          # --- 5. REVERT SEQUENCE ---
          print("\n‚ùå VIOLATIONS FOUND:")
          for err in errors:
              print(f" - {err}")
          
          print("\nüö® INITIATING AUTO-REVERT...")
          
          commands = [
              ["git", "config", "--global", "user.name", "Policy Bot"],
              ["git", "config", "--global", "user.email", "bot@noreply.github.com"],
              ["git", "revert", "HEAD", "--no-edit"],
              ["git", "commit", "--amend", "-m", "reverted: format violation"],
              ["git", "push", "origin", "HEAD"]
          ]

          try:
              for cmd in commands:
                  subprocess.run(cmd, check=True)
              print("‚úÖ REVERT COMPLETE.")
          except subprocess.CalledProcessError as e:
              print(f"CRITICAL ERROR during revert: {e}")
          
          sys.exit(1)
          
          # Fail the job
          sys.exit(1)
