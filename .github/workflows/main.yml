name: Enforce Policy & Auto-Revert

on:
  push:
    branches-ignore:
      - develop

permissions:
  contents: write  # <--- CRITICAL: Allows the Action to push the revert

jobs:
  enforce-and-revert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # <--- CRITICAL: We need full history to perform a revert

      - name: Check Message & Auto-Revert if Needed
        run: |
          # 1. Capture the message (Case Insensitive Check)
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "Analyzing commit: $COMMIT_MSG"

          # 2. Check if "mahmoud" is missing (grep -i = case insensitive)
          if ! echo "$COMMIT_MSG" | grep -iq "mahmoud"; then
            echo "âŒ VIOLATION: 'mahmoud' not found in commit message."
            echo "ðŸš¨ INITIATING AUTO-REVERT SEQUENCE..."

            # 3. Configure Git for the Bot
            git config --global user.name "Policy Enforcer Bot"
            git config --global user.email "bot@noreply.github.com"

            # 4. Revert the current HEAD
            # --no-edit: accept the default revert message temporarily
            git revert HEAD --no-edit

            # 5. Amend the message to your specific requirement
            git commit --amend -m "reverted because it's per guidelines"

            # 6. Push the changes back to the repo
            git push origin HEAD

            echo "âœ… REVERT COMPLETE. The bad commit has been undone."
            
            # 7. Fail the job so you see a Red Cross in GitHub Actions
            exit 1
          fi

          echo "âœ… PASSED: Commit contains 'mahmoud'."
